<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BCP App</title>
  <link rel="stylesheet" href="style.css"> 
   <script src="./config.js"></script>
</head>
<body>
    <header>
        <h1>è¨ªå•çœ‹è­·ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¾ã‚‹ã¾ã‚‹</h1>
        <h1>BCPã‚·ã‚¹ãƒ†ãƒ </h1>
        <p>å€‹åˆ¥æ”¯æ´è¨ˆç”»ã«åŸºã¥ãã€ç·Šæ€¥è¨“ç·´æ™‚ã¨ç½å®³æ™‚ã«ã¯ã“ã¡ã‚‰ã‚’åˆ©ç”¨ã—ã¾ã™</p>
        <p>æ¬¡å›å®Ÿæ–½æ—¥</p>
        <p>2024å¹´7æœˆ10æ—¥10:30</p>
<div id="myMap" style="width: 100%; height: 400px;"></div>
<h2>å®‰å¦ç¢ºèªé€ä¿¡æ¬„</h2>
<div>
    åå‰ï¼š<input type="text" id="uname"> 
    æ—¥ä»˜ï¼š<input type="date" id="day">
</div>
<div>
    <textarea id="text" cols="30" rows="10"></textarea>
    <button id="send">é€ä¿¡</button>
</div>
<div id="output" style="overflow: auto;height: auto;"></div>
<h1>BCPç™ºä»¤æ™‚ã®å¯¾å¿œã«ã¤ã„ã¦</h1>
<div class="section-sengen">ã“ã®BCPã‚·ã‚¹ãƒ†ãƒ ã«ã¤ã„ã¦</div>
        <div class="section-sengent">
          <p>ç½å®³æ™‚ã®BCPï¼ˆBusiness Continuity Planï¼šäº‹æ¥­ç¶™ç¶šè¨ˆç”»ï¼‰ç™ºä»¤æ™‚ã«ã€ç¾åœ¨åœ°ã‚’åŸºã«ã—ãŸåœ°å›³ã‚’ä½¿ç”¨ã—ã¦å®‰å¦ç¢ºèªã‚’è¡Œã†ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚
            </p>
            <p>åœ°åŸŸBCPãŒã‚ã£ãŸã‚‰
                é¿é›£æ‰€ã«åŒ»ç™‚å¾“äº‹è€…ãŒä½•äººã‹ãŠã‚‹ã¯ãš!!!ãã“ã§ç›¸è«‡ã—ã¦ã­</p>
        </div>
        <div class="section-sengen">è¨ªå•çœ‹è­·ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¾ã‚‹ã¾ã‚‹ã«ã¤ã„ã¦</div>
        <div class="section-sengent">
          <p>ã€’639-1123å¥ˆè‰¯çœŒå¤§å’Œéƒ¡å±±å¸‚ç­’äº•ç”º463-1 ãµãã¿ãƒ¼ã‚†ç­’äº•2éš12å·
            </p>
            <p>TEL:050-1807-4162</p>
            <p>Mailï¼šinfo@comaru.co.jp</p>

<!-- JQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<!--** ä»¥ä¸‹Firebase **-->

<script type="module">
// firebaseAPIkey.jsã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«
import firebaseConfig from "./firebaseAPIkey.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
import { getDatabase, set,ref, push,onChildAdded, onChildRemoved,onChildChanged, onValue } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
console.log(firebaseConfig)
// Firebaseã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–
const app = initializeApp(firebaseConfig);

// Realtime Databaseã¸ã®å‚ç…§ã‚’å–å¾—
const db = getDatabase(app);
const dbRef = ref(db, "chat"); // ä¾‹: 'chat'ãƒ‘ã‚¹ã¸ã®å‚ç…§
window.GetMap = GetMap;

//  // é€ä¿¡
$("#send").on("click", function () {
  const msg = {
      uname: $("#uname").val(),
      // day: $("#day").val(),
      text: $("#text").val(),
      datetime: formattedDateTime // æŒ‡å®šã—ãŸå½¢å¼ã§æ—¥æ™‚ã‚’è¿½åŠ 
      // datetime: new Date().toISOString() // ç¾åœ¨ã®æ—¥æ™‚ã‚’ISOå½¢å¼ã§å–å¾—ã—ã€datetimeãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«è¿½åŠ 
  }
  // console.log(msg); //ãƒã‚§ãƒƒã‚¯ã—ãŸã‚‰æ¶ˆã™
  const newPostRef = push(dbRef); // ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã‚’ç”Ÿæˆ
  set(newPostRef, msg); // "chat"ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯KEYã‚’ã¤ã‘ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²
  console.log(newPostRef);//ã“ã‚Œã‚’ã¿ãŸã‚‰ã€ã©ã†ã„ã†å‡¦ç†ãªã‚“ã‹ã‚ã‹ã‚‹ï¼
});
  // ã‚«ãƒ†ã‚´ãƒªãƒ¼æƒ…å ±ã‚’å—ä¿¡ã™ã‚‹
  onChildAdded(dbRef, function (data) {
  const msg = data.val();
  const key = data.key; // ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼
  let h = '<p id="' + key + '">'; // ã‚«ãƒ†ã‚´ãƒªãƒ¼æƒ…å ±ã¯ã“ã“ã§ã¯ä½¿ç”¨ã—ãªã„
  h += msg.uname + " ";
  if (msg.datetime) { // datetime ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿æ™‚é–“ã‚’è¡¨ç¤º
      h += msg.datetime + " ";
  }
  h += '<span contentEditable="true" id="' + key + '_update">' + msg.text + '</span>';
  h += '<span class="remove" data-key="' + key + '">ğŸš®</span>';
  h += '<span class="update" data-key="' + key + '">ğŸ†™</span>';
  h += '</p>';
  $("#output").prepend(h);
});

// å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆ
$("#output").on("click", ".remove", function () {
  const key = $(this).attr("data-key");
  const remove_item = ref(db, "chat/" + key); // å‚ç…§å…ˆã‚’ä¿®æ­£
  remove(remove_item); //Firebaseãƒ‡ãƒ¼ã‚¿å‰Šé™¤é–¢æ•°
});

// æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
$("#output").on("click", ".update", function () {
  const key = $(this).attr("data-key");
  update(ref(db, "chat/" + key), {
      text: $("#" + key + '_update').html()
  });
});

// å‰Šé™¤å‡¦ç†ãŒFirebaseå´ã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰
onChildRemoved(dbRef, (data) => {
  $("#" + data.key).remove(); //DOMæ“ä½œé–¢æ•°ï¼ˆå¯¾è±¡ã‚’å‰Šé™¤ï¼‰
});

// æ›´æ–°å‡¦ç†ãŒFirebaseå´ã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿï¼
onChildChanged(dbRef, (data) => {
  $("#" + data.key + '_update').html(data.val().text);
  $("#" + data.key + '_update').fadeOut(800).fadeIn(800);
});
const currentDate = new Date();
const year = currentDate.getFullYear();
const month = String(currentDate.getMonth() + 1).padStart(2, '0');
const day = String(currentDate.getDate()).padStart(2, '0');
const hours = String(currentDate.getHours()).padStart(2, '0');
const minutes = String(currentDate.getMinutes()).padStart(2, '0');
const seconds = String(currentDate.getSeconds()).padStart(2, '0');
const formattedDateTime = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
</script>
<script type='text/javascript'>
  document.addEventListener("DOMContentLoaded", function() {
    var script = document.createElement("script");
    script.src = 'https://www.bing.com/api/maps/mapcontrol?callback=GetMap&key=' + config.BING_MAPS_API_KEY;
    script.async = true;
    script.defer = true;
    document.body.appendChild(script);
  });
  // function saveLocation(lat, lng) {
  //           // Specify the path where latitude and longitude should be saved in Firebase Realtime Database
  //           const locationRef = firebase.ref(database, 'place');
  //           // Data to be saved
  //           const locationData = {
  //               latitude: lat,
  //               longitude: lng,
  //               timestamp: firebase.database.ServerValue.TIMESTAMP // Saves the server timestamp
  //           };
  //           // Save the location data to Firebase
  //           firebase.set(locationRef, locationData, (error) => {
  //               if (error) {
  //                   console.error("Error saving location data:", error);
  //               } else {
  //                   console.log("Location data saved successfully.");
  //               }
  //           });
  //       }
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;

                    // Save the latitude and longitude to Firebase
                    // saveLocation(lat, lng);
                }, (error) => {
                    console.error("Geolocation error:", error);
                });
            } else {
                console.error("Geolocation is not supported by this browser.");
            }
        }
        document.addEventListener('DOMContentLoaded', (event) => {
            getLocation();
        });
</script>
  <script type="text/javascript">
    function GetMap() {
        map = new Microsoft.Maps.Map('#myMap', {
          center: new Microsoft.Maps.Location(34.618644, 135.7859943),
        mapTypeId: Microsoft.Maps.MapTypeId.canvasLight,
        zoom: 11
    });
    //  è¨ªå•çœ‹è­·ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã€Œã¾ã‚‹ã¾ã‚‹ã€ã®ä½ç½®ã«ãƒ”ãƒ³ã‚’ç«‹ã¦ã‚‹
    const marumaruLocation = new Microsoft.Maps.Location(34.618644, 135.7859943);
    const marumaruPin = new Microsoft.Maps.Pushpin(marumaruLocation, {
        text: 'ã¾ã‚‹ã¾ã‚‹'
    });
    map.entities.push(marumaruPin);

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¾åœ¨ä½ç½®ã‚’å–å¾—ã—ã¦ãƒ”ãƒ³ã‚’ç«‹ã¦ã‚‹
    getUserLocationAndPin();
  }
  // ä½ç½®æƒ…å ±å–å¾—ã‚ªãƒ—ã‚·ãƒ§ãƒ³
const options = {
  enableHighAccuracy: true,
  maximumAge: 20000,
  timeout: 10000
};
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¾åœ¨ä½ç½®ã‚’å–å¾—ã—ã¦ãƒ”ãƒ³ã‚’ç«‹ã¦ã‚‹
   function getUserLocationAndPin() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            loc = new Microsoft.Maps.Location(position.coords.latitude, position.coords.longitude);
            addPin(loc, ""); // ç¾åœ¨åœ°ã«ãƒ”ãƒ³ã‚’ç«‹ã¦ã‚‹
            map.setView({ center: loc, zoom: 11 });
        }, function(error) {
            console.error('Geolocation error: ', error);
        });
    } else {
        alert("Geolocation APIã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
    }
}
 // ä½ç½®æƒ…å ±ã®å–å¾—ã«æˆåŠŸã—ãŸæ™‚ã®å‡¦ç†
 function mapsInit(position) {
  const lat = position.coords.latitude;
  const lon = position.coords.longitude;
  console.log("ç·¯åº¦:", lat, "çµŒåº¦:", lon);
}
// ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ãŸå ´åˆã®å‡¦ç†
function mapsError(error) {
  let e = "";
  if (error.code == 1) {
    e = "ä½ç½®æƒ…å ±ãŒè¨±å¯ã•ã‚Œã¦ã¾ã›ã‚“";
  }
  if (error.code == 2) {
    e = "ç¾åœ¨ä½ç½®ã‚’ç‰¹å®šã§ãã¾ã›ã‚“";
  }
  if (error.code == 3) {
    e = "ä½ç½®æƒ…å ±ã‚’å–å¾—ã™ã‚‹å‰ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã«ãªã‚Šã¾ã—ãŸ";
  }
  console.error("ã‚¨ãƒ©ãƒ¼ï¼š", e);
}
// ä½ç½®æƒ…å ±ã‚’å–å¾—ã™ã‚‹å‡¦ç†
navigator.geolocation.getCurrentPosition(mapsInit, mapsError, options);
// åœ°å›³ä¸Šã«ãƒ”ãƒ³ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
function addPin(location, text) {
    const pin = new Microsoft.Maps.Pushpin(location, { text: text });
    map.entities.push(pin);
}
  </script>
<footer>
  <small>è¨ªå•çœ‹è­·ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¾ã‚‹ã¾ã‚‹</small>
</footer>
<script src="main.js"></script>
</body>
</html>
