<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BCP App</title>
  <link rel="stylesheet" href="style.css"> 
   <script src="./config.js"></script>
</head>
<body>
    <header>
        <h1>訪問看護ステーションまるまる</h1>
        <h1>BCPシステム</h1>
        <p>個別支援計画に基づき、緊急訓練時と災害時にはこちらを利用します</p>
        <p>次回実施日</p>
        <p>2024年7月10日10:30</p>
<div id="myMap" style="width: 100%; height: 400px;"></div>
<h2>安否確認送信欄</h2>
<div>
    名前：<input type="text" id="uname"> 
    日付：<input type="date" id="day">
</div>
<div>
    <textarea id="text" cols="30" rows="10"></textarea>
    <button id="send">送信</button>
</div>
<div id="output" style="overflow: auto;height: auto;"></div>
<h1>BCP発令時の対応について</h1>
<div class="section-sengen">このBCPシステムについて</div>
        <div class="section-sengent">
          <p>災害時のBCP（Business Continuity Plan：事業継続計画）発令時に、現在地を基にした地図を使用して安否確認を行うシステムです。
            </p>
            <p>地域BCPがあったら
                避難所に医療従事者が何人かおるはず!!!そこで相談してね</p>
        </div>
        <div class="section-sengen">訪問看護ステーションまるまるについて</div>
        <div class="section-sengent">
          <p>〒639-1123奈良県大和郡山市筒井町463-1 ふぁみーゆ筒井2階12号
            </p>
            <p>TEL:050-1807-4162</p>
            <p>Mail：info@comaru.co.jp</p>

<!-- JQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<!--** 以下Firebase **-->

<script type="module">
// firebaseAPIkey.jsからエクスポートしたファイル
import firebaseConfig from "./firebaseAPIkey.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
import { getDatabase, set,ref, push,onChildAdded, onChildRemoved,onChildChanged, onValue } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
console.log(firebaseConfig)
// Firebaseアプリの初期化
const app = initializeApp(firebaseConfig);

// Realtime Databaseへの参照を取得
const db = getDatabase(app);
const dbRef = ref(db, "chat"); // 例: 'chat'パスへの参照
window.GetMap = GetMap;

//  // 送信
$("#send").on("click", function () {
  const msg = {
      uname: $("#uname").val(),
      // day: $("#day").val(),
      text: $("#text").val(),
      datetime: formattedDateTime // 指定した形式で日時を追加
      // datetime: new Date().toISOString() // 現在の日時をISO形式で取得し、datetimeプロパティに追加
  }
  // console.log(msg); //チェックしたら消す
  const newPostRef = push(dbRef); // ユニークキーを生成
  set(newPostRef, msg); // "chat"にユニークKEYをつけてオブジェクトデータを登録
  console.log(newPostRef);//これをみたら、どういう処理なんかわかる！
});
  // カテゴリー情報を受信する
  onChildAdded(dbRef, function (data) {
  const msg = data.val();
  const key = data.key; // ユニークキー
  let h = '<p id="' + key + '">'; // カテゴリー情報はここでは使用しない
  h += msg.uname + " ";
  if (msg.datetime) { // datetime プロパティが存在する場合のみ時間を表示
      h += msg.datetime + " ";
  }
  h += '<span contentEditable="true" id="' + key + '_update">' + msg.text + '</span>';
  h += '<span class="remove" data-key="' + key + '">🚮</span>';
  h += '<span class="update" data-key="' + key + '">🆙</span>';
  h += '</p>';
  $("#output").prepend(h);
});

// 削除イベント
$("#output").on("click", ".remove", function () {
  const key = $(this).attr("data-key");
  const remove_item = ref(db, "chat/" + key); // 参照先を修正
  remove(remove_item); //Firebaseデータ削除関数
});

// 更新イベント
$("#output").on("click", ".update", function () {
  const key = $(this).attr("data-key");
  update(ref(db, "chat/" + key), {
      text: $("#" + key + '_update').html()
  });
});

// 削除処理がFirebase側で実行されたら
onChildRemoved(dbRef, (data) => {
  $("#" + data.key).remove(); //DOM操作関数（対象を削除）
});

// 更新処理がFirebase側で実行されたらイベント発生！
onChildChanged(dbRef, (data) => {
  $("#" + data.key + '_update').html(data.val().text);
  $("#" + data.key + '_update').fadeOut(800).fadeIn(800);
});
const currentDate = new Date();
const year = currentDate.getFullYear();
const month = String(currentDate.getMonth() + 1).padStart(2, '0');
const day = String(currentDate.getDate()).padStart(2, '0');
const hours = String(currentDate.getHours()).padStart(2, '0');
const minutes = String(currentDate.getMinutes()).padStart(2, '0');
const seconds = String(currentDate.getSeconds()).padStart(2, '0');
const formattedDateTime = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
</script>
<script type='text/javascript'>
  document.addEventListener("DOMContentLoaded", function() {
    var script = document.createElement("script");
    script.src = 'https://www.bing.com/api/maps/mapcontrol?callback=GetMap&key=' + config.BING_MAPS_API_KEY;
    script.async = true;
    script.defer = true;
    document.body.appendChild(script);
  });
  // function saveLocation(lat, lng) {
  //           // Specify the path where latitude and longitude should be saved in Firebase Realtime Database
  //           const locationRef = firebase.ref(database, 'place');
  //           // Data to be saved
  //           const locationData = {
  //               latitude: lat,
  //               longitude: lng,
  //               timestamp: firebase.database.ServerValue.TIMESTAMP // Saves the server timestamp
  //           };
  //           // Save the location data to Firebase
  //           firebase.set(locationRef, locationData, (error) => {
  //               if (error) {
  //                   console.error("Error saving location data:", error);
  //               } else {
  //                   console.log("Location data saved successfully.");
  //               }
  //           });
  //       }
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;

                    // Save the latitude and longitude to Firebase
                    // saveLocation(lat, lng);
                }, (error) => {
                    console.error("Geolocation error:", error);
                });
            } else {
                console.error("Geolocation is not supported by this browser.");
            }
        }
        document.addEventListener('DOMContentLoaded', (event) => {
            getLocation();
        });
</script>
  <script type="text/javascript">
    function GetMap() {
        map = new Microsoft.Maps.Map('#myMap', {
          center: new Microsoft.Maps.Location(34.618644, 135.7859943),
        mapTypeId: Microsoft.Maps.MapTypeId.canvasLight,
        zoom: 11
    });
    //  訪問看護ステーション「まるまる」の位置にピンを立てる
    const marumaruLocation = new Microsoft.Maps.Location(34.618644, 135.7859943);
    const marumaruPin = new Microsoft.Maps.Pushpin(marumaruLocation, {
        text: 'まるまる'
    });
    map.entities.push(marumaruPin);

    // ユーザーの現在位置を取得してピンを立てる
    getUserLocationAndPin();
  }
  // 位置情報取得オプション
const options = {
  enableHighAccuracy: true,
  maximumAge: 20000,
  timeout: 10000
};
    // ユーザーの現在位置を取得してピンを立てる
   function getUserLocationAndPin() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            loc = new Microsoft.Maps.Location(position.coords.latitude, position.coords.longitude);
            addPin(loc, ""); // 現在地にピンを立てる
            map.setView({ center: loc, zoom: 11 });
        }, function(error) {
            console.error('Geolocation error: ', error);
        });
    } else {
        alert("Geolocation APIはこのブラウザではサポートされていません。");
    }
}
 // 位置情報の取得に成功した時の処理
 function mapsInit(position) {
  const lat = position.coords.latitude;
  const lon = position.coords.longitude;
  console.log("緯度:", lat, "経度:", lon);
}
// 位置情報の取得に失敗した場合の処理
function mapsError(error) {
  let e = "";
  if (error.code == 1) {
    e = "位置情報が許可されてません";
  }
  if (error.code == 2) {
    e = "現在位置を特定できません";
  }
  if (error.code == 3) {
    e = "位置情報を取得する前にタイムアウトになりました";
  }
  console.error("エラー：", e);
}
// 位置情報を取得する処理
navigator.geolocation.getCurrentPosition(mapsInit, mapsError, options);
// 地図上にピンを追加する関数
function addPin(location, text) {
    const pin = new Microsoft.Maps.Pushpin(location, { text: text });
    map.entities.push(pin);
}
  </script>
<footer>
  <small>訪問看護ステーションまるまる</small>
</footer>
<script src="main.js"></script>
</body>
</html>
